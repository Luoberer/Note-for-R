---
title: "Note for R (Lec 4-5)"
author: "Luo Beier"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    theme: paper
    toc_depth: 4
  pdf_document:
    toc: yes
---

# R 语言

首先，我们先介绍一个新的传递数据的方法：**Pipe operator**

## Pipe operator

A key package: **tidyverse**

Suppose that we want to find the following summation:
$$
\sqrt{\sum_{i=-10}^{10}|i|}.
$$
Base-R, we can:
```{r}
sqrt(sum(abs(-10:10)))
```

We can use pipe operator to deal with multiple functions like this:

```{r}
library(tidyverse)
-10:10 %>% 
  abs() %>%
  sum() %>%
  sqrt()
```

**More logical!**

When you have multiple arguments in a function:
```{r}
matrix(1:10, nrow = 2, byrow = TRUE)

1:10 %>%
matrix(nrow = 2, byrow = TRUE)
```

## 基本数据管理

```{r}
library(tidyverse)
library(palmerpenguins)
```

### mutate()

我们想再创建一个新的变量:

```{r}
df <- penguins
attach(df)
df$bill_sum <- bill_length_mm + bill_depth_mm
detach(df)
```

在tidyverse包下，可以使用mutate()函数：

```{r}
library(tidyverse)
mutate(.data = df, bill_sum = bill_length_mm + bill_depth_mm)
## or,
mutate(df, bill_sum = bill_length_mm + bill_depth_mm)
## or, using pipe operator:
df %>%
mutate(bill_sum = bill_length_mm + bill_depth_mm)
```

### 选取列 select()

#### 按名称选取

```{r}
df <- penguins # 初始化 df 变量
df %>% select(bill_length_mm, bill_depth_mm)
df %>% select(-bill_length_mm, -bill_depth_mm) #按名称删除不需要的列
```

#### 按名称所含字符选取

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221016144628525.png)
#### 按数值类型选取

```{r}
df %>% select(where(is.numeric))
df %>% select(where(is.double))
```

#### 混合选取

```{r,eval=FALSE,message=TRUE}
## 逻辑并
select(df, 条件一 & 条件二)
## 逻辑或
select(df, 条件一 | 条件二)
## 逻辑非
select(df, !条件一)
```

### 修改列名

```{r}
df %>%
rename(Bill.Length = bill_length_mm,
Bill.Depth = bill_depth_mm,
Flipper.Length = flipper_length_mm,
Body.Mass = body_mass_g) #等号前是新名字，等号后面是老名字
```

### 按行选取 filter()

比如，我们想要选择species为"Adelie"的这些样本点：

```{r}
df %>% filter(species == "Adelie")
```

进一步再选取bill_length_mm大于 40 的：

```{r}
df %>% filter(species == "Adelie",
bill_length_mm > 40)
```

### 排序 arrange()

arrange(df, variable)（升序），或者 arrange(df, -variable)（降序）。

也可以对多个变量依次排序。比如先对变量一排序，再对变量二排序，其公式为：

```{r,eval=FALSE,message=TRUE}
arrange(df, var1, var2)
```

### 合并数据

#### bind_cols(df1,df2,...)

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221016153936165.png)

#### 连接数据_join()函数族

左联结 left_join():

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221016154219652.png)

还有右联结right_join(), inner_join和full_join等。

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221016154356079.png)

### 缺失值

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221016155308797.png)
We can also do something to the origianl data to delete the NA value:

```{r}
mean(penguins$body_mass_g)
penguins1 <- penguins[complete.cases(penguins),]
mean(penguins1$body_mass_g)
```

### 数据规整

若我们有一组植物的高度数据
```{r}
plant_height <- data.frame(
Day = 1:5,
A = c(0.7, 1.0, 1.5, 1.8, 2.2),
B = c(0.5, 0.7, 0.9, 1.3, 1.8),
C = c(0.3, 0.6, 1.0, 1.2, 2.2),
D = c(0.4, 0.7, 1.2, 1.5, 3.2)
)
```

此时的数据形如：
```{r}
plant_height
```

若我们想将其转化为：
```{r,echo=FALSE}
plant_height %>% pivot_longer(cols = A:D,names_to = "plant",values_to = "height")
```

则我们需要pivot_longer()来使表格变长：

#### pivot_longer()

上述步骤的代码为：
```{r}
long <- plant_height %>% pivot_longer(cols = A:D,names_to = "plant",values_to = "height") # cols= 代表需要将哪几列转换成行；names_to=表示转换成行的这几列的名字对应转换后的哪一列；values_to=表示转换成行的这几列的数据对应转换后的哪一列
long
```

#### pivot_wider()

同样，我们也有使表格变宽的方法：
```{r}
wide <- long %>% pivot_wider(names_from = "plant",
values_from = "height") # names_from=表示转换后的表格的列的名字来源；values_from=表示转换后的表格的列的数据来源于
wide
```

复杂一点的例子：
```{r}
plant_record <- data.frame(
day = c(1L, 2L, 3L, 4L, 5L),
A_height = c(1.1, 1.2, 1.3, 1.4, 1.5),
A_width = c(2.1, 2.2, 2.3, 2.4, 2.5),
A_depth = c(3.1, 3.2, 3.3, 3.4, 3.5),
B_height = c(4.1, 4.2, 4.3, 4.4, 4.5),
B_width = c(5.1, 5.2, 5.3, 5.4, 5.5),
B_depth = c(6.1, 6.2, 6.3, 6.4, 6.5),
C_height = c(7.1, 7.2, 7.3, 7.4, 7.5),
C_width = c(8.1, 8.2, 8.3, 8.4, 8.5),
C_depth = c(9.1, 9.2, 9.3, 9.4, 9.5)
)
as_tibble(plant_record)
```

```{r}
plant_record_longer <- plant_record %>%
tidyr::pivot_longer(
cols = !day,
names_to = c("species", ".value"),
names_pattern = "(.*)_(.*)"
)
plant_record_longer %>% slice(1:10)
```

变回去：
```{r}
plant_record_wider <- plant_record_longer %>%
tidyr::pivot_wider(
names_from = species,
values_from = c(height, width, depth),
names_glue = "{species}_{.value}"
)
plant_record_wider
```

## From data set to a random variables

### summary()

+ Working with numbers:
  + center: sample mean, sample median, and so on
  + spread: standard deviation, range, quantiles, IQR(Interquartile range), and so on
  + skewness

```{r}
body_mass_g <- penguins$body_mass_g
summary(body_mass_g)
```

Or we can customize our summary output:

```{r}
penguins %>%
  summarize(mean = mean(body_mass_g),
            median = median(body_mass_g),
            sd = sd(body_mass_g),
            IQR = IQR(body_mass_g,na.rm=TRUE))
```

If we want to calculate the mean of one particular *species*, we can use **group_by()** and **summarize**

```{r}
penguins %>%
  group_by(species) %>%
  summarize(n = length(body_mass_g),
            mean = mean(body_mass_g,na.rm = TRUE),
            sd = sd(body_mass_g,na.rm = TRUE))
```

We can add more information like *sex*:

```{r}
penguins[complete.cases(penguins),]%>%  # 去掉所有的NA
  group_by(species,sex) %>%
  summarize(n = length(body_mass_g),
            mean = mean(body_mass_g,na.rm = TRUE),
            sd = sd(body_mass_g,na.rm = TRUE))
```

### Probability models

#### Joint count:
```{r}
(joint_table <- penguins %>%
   xtabs(~species + sex, data = .)) %>% # 管道操作时，传过来的数据做为非第一参数时，必须用.代替
  addmargins()   # 计算 sum
```

#### Joint probability
```{r}
joint_table %>%
  prop.table() %>%
  round(digit = 3) %>% # 保留三位有效数字
  addmargins()
```

#### Marginal distribution
```{r}
library(magrittr)
joint_table %>%
margin.table(1) %T>% #向左传递值到print(),但下一个%>%仍然由margin.table(1)传递而不是print()
print() %>%
prop.table()

joint_table %>%
margin.table(2) %T>%
print() %>%
prop.table()
```

#### Conditional distribution
```{r}
joint_table %>% prop.table(margin = 1) #已知第一个变量species求条件分布
joint_table %>% prop.table(margin = 2)
```

#### Draw distribute plot

```{r}
ggplot(data = penguins, aes(x = body_mass_g, y = ..density.., fill = species)) +
  geom_density(color = "black", alpha = 0.5)
```

Sometimes we can also use **boxplot()**

```{r}
ggplot(data = penguins, aes(x=species, y=body_mass_g, fill=species)) +
  geom_boxplot(color="black", alpha=0.5)
```

#### Calculate Sample Mean and Covariance

**Mean**
```{r}
penguins1 %>% 
  select(where(is.numeric)) %>% 
  colMeans() %>% 
  knitr::kable()  # 用表格表示
```

**Covariance Matrix**
```{r}
penguins1 %>%
  select(where(is.numeric)) %>%
  rename(X1 = bill_length_mm,
         X2 = bill_depth_mm,
         X3 = flipper_length_mm,
         X4 = body_mass_g,
         X5 = year) %>%  #改名防止矩阵名字过长影响美观
  var() %>%
  round(digit = 2) %>%
  knitr:: kable()
```

**Correlation Matrix**
```{r}
penguins1 %>%
  select(where(is.numeric)) %>%
  rename(X1 = bill_length_mm,
         X2 = bill_depth_mm,
         X3 = flipper_length_mm,
         X4 = body_mass_g,
         X5 = year) %>%  #改名防止矩阵名字过长影响美观
  cor() %>%
  round(digit = 2) %>%
  knitr:: kable()
```

## Generate random variables by the build-in functions

### Common probability distributions

| Letter | Description |
| :-- | :-- |
| d | density |
| p | probability, distribution function |
| q | quantile function |
| r | random generation |

For example:

```{r}
dnorm(0)#Normal distribution 的f(x)在x=0处的值
pnorm(0)#F(0)
qnorm(0.25)#Normal distribution 的F(x)小于等于0.25时x的值
rnorm(100) #生成n个服从Normal distribution的点
```

![](C:\Users\luobe\AppData\Roaming\Typora\typora-user-images\image-20221020181953722.png)

### Generate normal random variables
```{r}
rnorm(100,mean=0,sd=1) %>%
  hist()

rnorm(100) %>%
  summary()
```

### Generate multivariate normal random variables
```{r}
library(MASS)
set.seed(1234)
mu <- c(10, 20)
sigma <- matrix(c(1, 0.5, 0.5, 1), nrow = 2)
mvrnorm(100, mu, sigma) %>%
plot()
```
